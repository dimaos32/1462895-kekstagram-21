(()=>{"use strict";(()=>{const e={symbol:["символ","символа","символов"]};window.utils={Key:{ENTER:"Enter",ESCAPE:"Escape"},checkExtensionAccordance:(e,t)=>t.some((t=>e.name.toLowerCase().endsWith(t))),getQEndings:(t=1,n)=>{if(t%100<11||t%100>14){if(t%10==1)return`${t} ${e[n][0]}`;if(t%10>1&&t%10<5)return`${t} ${e[n][1]}`}return`${t} ${e[n][2]}`},getRandomArrayElements:(e,t=1)=>{let n=e.slice(),o=[];for(let e=0;e<n.length&&e<t;e++){const t=e+Math.floor(Math.random()*(n.length-e));o.push(n[t]);const s=n[t];n[t]=n[e],n[e]=s}return o},addId:e=>e.map(((e,t)=>Object.assign({},e,{id:""+t}))),debounce:(e,t=500)=>{let n=null;return function(...o){n&&window.clearTimeout(n),n=window.setTimeout((()=>{e(...o)}),t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram",t=(e,t,n,o,s)=>{const r=new XMLHttpRequest;r.responseType="json",r.timeout=1e4,r.open(e,t),"POST"===e?r.send(s):r.send(),r.addEventListener("load",(()=>{200===r.status?n(r.response):o(`Статус ответа: ${r.status} ${r.statusText}`)})),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${r.timeout/1e3} с`)}))};window.backend={load:(n,o)=>{t("GET",e+"/data",n,o)},send:(n,o,s)=>{t("POST",e,o,s,n)}}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector(".big-picture"),n=t.querySelector(".big-picture__cancel"),o=document.querySelector("#picture").content.querySelector(".picture"),s=document.querySelector(".pictures"),r=e=>{const t=o.cloneNode(!0);return t.dataset.id=e.id,t.querySelector(".picture__img").src=e.url,t.querySelector(".picture__img").alt=e.description,t.querySelector(".picture__comments").textContent=""+e.comments.length,t.querySelector(".picture__likes").textContent=""+e.likes,t};s.addEventListener("click",(o=>{(o=>{o.target.closest(".picture")&&(o.preventDefault(),(o=>{const s=window.photos.find((e=>e.id===o)),{comments:r,description:c,likes:l,url:i}=s,a=t.querySelector(".comments-shown"),d=t.querySelector(".comments-count"),u=t.querySelector(".social__comments"),m=document.querySelector("#social__comment").content.querySelector(".social__comment"),y=t.querySelector(".social__comments-loader"),p=e=>{const t=m.cloneNode(!0);t.querySelector(".social__picture").src=r[e].avatar,t.querySelector(".social__picture").alt=r[e].name,t.querySelector(".social__text").textContent=r[e].message,u.append(t)},v=()=>{const e=parseInt(d.textContent,10)-parseInt(a.textContent,10)<5?parseInt(d.textContent,10)-parseInt(a.textContent,10):5;for(let t=parseInt(a.textContent,10);t<parseInt(a.textContent,10)+e;t++)p(t);a.textContent=""+(parseInt(a.textContent,10)+e),a.textContent===d.textContent&&y.classList.add("hidden")},f=()=>{v()},_=()=>{t.classList.add("hidden"),e.classList.remove("modal-open"),y.classList.remove("hidden"),y.removeEventListener("click",f),n.removeEventListener("click",w),document.removeEventListener("keydown",g)},w=()=>{_()},g=e=>{e.key===window.utils.Key.ESCAPE&&(e.preventDefault(),_())};t.querySelector(".big-picture__img img").src=i,t.querySelector(".social__caption").textContent=c,t.querySelector(".likes-count").textContent=""+l,a.textContent=0,d.textContent=""+r.length,u.innerHTML="",v(),t.classList.remove("hidden"),e.classList.add("modal-open"),y.addEventListener("click",f),n.addEventListener("click",w),document.addEventListener("keydown",g)})(o.target.closest(".picture").dataset.id))})(o)})),window.pictures={renderPhotos:e=>{const t=document.createDocumentFragment();s.querySelectorAll(".picture").forEach((e=>{e.remove()}));for(let n=0;n<e.length;n++)t.append(r(e[n]));s.append(t)}}})(),(()=>{const e=100,t=document.querySelector(".img-upload__overlay"),n=t.querySelector(".img-upload__preview img"),o=t.querySelector(".effects__list"),s=t.querySelector("#effect-none"),r=t.querySelector(".effect-level"),c=t.querySelector(".effect-level__value"),l=t.querySelector(".effect-level__pin"),i=t.querySelector(".effect-level__depth");let a,d="none";const u={none:()=>{n.className="",n.style.filter=""},chrome:t=>{const o=0+1*t/e;n.className="effects__preview--chrome",n.style.filter=`grayscale(${o})`},sepia:t=>{const o=0+1*t/e;n.className="effects__preview--sepia",n.style.filter=`sepia(${o})`},marvin:t=>{const o=0+100*t/e;n.className="effects__preview--marvin",n.style.filter=`invert(${o}%)`},phobos:t=>{const o=Math.round(0+3*t/e);n.className="effects__preview--phobos",n.style.filter=`blur(${o}px)`},heat:t=>{const o=1+2*t/e;n.className="effects__preview--heat",n.style.filter=`brightness(${o})`}},m=()=>{a=e,l.style.left="100%",i.style.width=l.style.left};o.addEventListener("change",(e=>{m(),d=e.target.value,u[d](a),r.style.display="block","none"===d&&(r.style.display="none")})),l.addEventListener("mousedown",(function(t){t.preventDefault();let n=t.clientX;const o=function(t){t.preventDefault();const o=t.clientX-n;n=t.clientX,a+=o*e/453,a<0&&(a=0),a>e&&(a=e),u[d](a),l.style.left=a+"%",i.style.width=l.style.left},s=function(e){e.preventDefault(),c.value=Math.round(a),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",s)})),window.effects={resetPinPos:m,resetEffects:()=>{s.checked=!0}}})(),(()=>{const e=/^#[\wА-Яа-я]{1,19}$/,t=document.querySelector("body"),n=document.querySelector(".img-upload__form"),o=n.querySelector(".img-upload__overlay"),s=o.querySelector("#upload-cancel"),r=o.querySelector(".scale__control--smaller"),c=o.querySelector(".scale__control--bigger"),l=o.querySelector(".scale__control--value"),i=o.querySelector(".img-upload__preview img"),a=o.querySelector(".text__description"),d=o.querySelector(".text__hashtags"),u=()=>{o.classList.add("hidden"),t.classList.remove("modal-open")},m=(e=1)=>{i.style="transform: scale("+e},y=()=>{m(),l.value="100%",window.effects.resetPinPos(),window.effects.resetEffects(),i.className="",i.style.filter="",a.value="",d.value="",u()},p=()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);y(),e.append(t),t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",(e=>{e.key===window.utils.Key.ESCAPE&&t.remove()}))},v=()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);y(),e.append(t),t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",(e=>{e.key===window.utils.Key.ESCAPE&&t.remove()}))};s.addEventListener("click",(()=>{u()})),document.addEventListener("keydown",(e=>{e.key===window.utils.Key.ESCAPE&&a!==document.activeElement&&d!==document.activeElement&&(e.preventDefault(),u())})),r.addEventListener("click",(()=>{(()=>{const e=parseInt(l.value,10);e>25&&(l.value=e-25+"%",m((e-25)/100))})()})),c.addEventListener("click",(()=>{(()=>{const e=parseInt(l.value,10);e<100&&(l.value=e+25+"%",m((e+25)/100))})()})),d.addEventListener("input",(()=>{const t=(t=>{const n=t.trim().toLowerCase().split(" ").sort();if(n.length>5)return{value:!1,reason:"QUANTITY"};for(let t=0;t<n.length;t++){if(!e.test(n[t]))return{value:!1,reason:"RE"};if(t>0&&n[t]===n[t-1])return{value:!1,reason:"DOUBLING"}}return{value:!0}})(d.value);if(t.value)d.classList.remove("text__not-valid"),d.setCustomValidity("");else switch(d.classList.add("text__not-valid"),t.reason){case"QUANTITY":d.setCustomValidity("Укажите не более 5 хэш-тегов");break;case"RE":d.setCustomValidity("Каждый хэш-тег должен начинаться с символа # (решётка), может состоять из букв, чисел и _ (символ подчеркивания), хеш-тег не может состоять только из одной решётки, максимальная длина одного хэш-тега 20 символов, включая решётку");break;case"DOUBLING":d.setCustomValidity("Один и тот же хэш-тег не может быть использован дважды, хэш-теги нечувствительны к регистру (#ХэшТег и #хэштег считаются одним и тем же тегом)")}d.reportValidity()})),a.addEventListener("input",(()=>{const e=a.value.length;if(e>140){const t=e-140;a.classList.add("text__not-valid"),a.setCustomValidity("Допустимая длинна комментария - 140 символов. Удалите "+window.utils.getQEndings(t,"symbol"))}else a.classList.remove("text__not-valid"),a.setCustomValidity("");a.reportValidity()})),n.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(n),p,v)}))})(),(()=>{const e={"filter-default":()=>window.photos,"filter-random":()=>window.utils.getRandomArrayElements(window.photos,10),"filter-discussed":()=>window.photos.slice().sort(((e,t)=>t.comments.length-e.comments.length))},t=document.querySelector(".img-filters__form");t.addEventListener("click",window.utils.debounce((n=>{t.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),n.target.classList.add("img-filters__button--active"),window.pictures.renderPhotos(e[n.target.id]())})))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("body"),n=document.querySelector(".img-upload__form"),o=n.querySelector("#upload-file"),s=n.querySelector(".img-upload__preview img"),r=n.querySelector(".img-upload__overlay"),c=document.querySelector(".img-filters");window.backend.load((e=>{window.photos=window.utils.addId(e),window.pictures.renderPhotos(window.photos),c.classList.remove("img-filters--inactive")}),(e=>{const t=document.createElement("div");t.classList.add("on-error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),o.addEventListener("change",(n=>{(n=>{const o=n.target.files[0];if(window.utils.checkExtensionAccordance(o,e)){const e=new FileReader;e.addEventListener("load",(()=>{r.classList.remove("hidden"),t.classList.add("modal-open"),s.src=e.result})),e.readAsDataURL(o)}})(n)}))})()})();